<div class="epub-container" [class.pdf-mode]="isPdf" [attr.data-theme]="theme()" [class.focus-mode]="focusMode()" role="main" [attr.aria-label]="isPdf ? 'PDF reader' : 'EPUB reader'">
  <!-- Screen reader live region for page announcements -->
  <div class="sr-only" aria-live="polite" aria-atomic="true" role="status">
    {{ currentLocation }}
  </div>
  <!-- Reading progress bar -->
  <app-reading-progress 
    [progress]="readingProgress$ | async" 
    [theme]="theme()"
    [class.hidden-in-focus]="focusMode()">
  </app-reading-progress>

  <!-- Unified settings panel -->
  <app-unified-settings-panel
    [isOpen]="panelOpen()"
    [theme]="theme()"
    [isPdf]="isPdf"
    [settings]="currentSettings"
    [chapters]="chapters()"
    [currentChapter]="currentChapterHref()"
    [bookmarks]="(bookmarks$ | async) ?? []"
    [readingStats]="(readingStats$ | async) ?? null"
    [readingGoal]="(readingGoal$ | async) ?? null"
    [todayReadingTime]="(todayReadingTime$ | async) ?? null"
    [progressPercent]="(readingProgress$ | async) ?? null"
    (close)="togglePanel()"
    (settingsChange)="onSettingsChange($event)"
    (chapterSelect)="onChapterSelect($event)"
    (bookmarkJump)="jumpToBookmark($event)"
    (bookmarkRemove)="removeBookmark($event)">
  </app-unified-settings-panel>

  <div #zoomWrapper class="zoom-wrapper" [class.pdf-scroll-wrapper]="isPdf"
    (click)="onViewerClick()"
    (touchstart)="onSwipeTouchStart($event)"
    (touchend)="onSwipeTouchEnd($event)">
    <div #viewer class="epub-viewer" [class.pdf-viewer]="isPdf" role="document" [attr.aria-label]="isPdf ? 'PDF content' : 'Book content'"></div>
  </div>
  
  <!-- Top bar: navigation + settings toggle -->
  <nav class="reader-controls" [class.hidden-in-focus]="focusMode()" [class.focus-temporary-show]="focusModeControlsVisible()" aria-label="Reader navigation">
    <button
      class="bookmark-toggle"
      (click)="toggleBookmarkAtCurrentLocation()"
      [class.bookmarked]="isCurrentLocationBookmarked()"
      [attr.aria-label]="isCurrentLocationBookmarked() ? 'Remove bookmark' : 'Add bookmark'"
      title="Toggle bookmark">
      {{ isCurrentLocationBookmarked() ? 'üîñ' : 'üè∑Ô∏è' }}
    </button>

    <button (click)="prevPage()" [disabled]="!canGoPrev" aria-label="Previous page">
      {{'<'}}

    </button>
    <span
      class="page-info"
      (click)="togglePageInfo()"
      title="Click to toggle progress">
      @if (showProgress()) {
        {{ (readingProgress$ | async) ?? 0 }}% complete
      } @else {
        {{ currentLocation }}
      }
    </span>
    
    
    
    <button (click)="nextPage()" [disabled]="!canGoNext" aria-label="Next page">{{'>'}}</button>

    @if (estimatedTimeRemaining$ | async; as eta) {
      <span class="eta-badge" title="Estimated time remaining">{{ eta }}</span>
    }

    <!-- Settings button -->
    <button
      class="panel-toggle"
      (click)="togglePanel()"
      [attr.aria-expanded]="panelOpen()"
      aria-label="Open settings panel"
      title="Settings & More">
      ‚öôÔ∏è
    </button>
  </nav>

  <!-- Follow mode indicator -->
  @if (followMode()) {
    <div class="follow-mode-indicator">
      <div class="follow-mode-header">
        <span class="follow-mode-title">
          {{ followModePaused() ? '‚è∏Ô∏è Follow Mode (Paused)' : '‚ñ∂Ô∏è Follow Mode' }}
        </span>
        <span class="follow-mode-speed">{{ followModeSpeed() }} WPM</span>
      </div>
      <small class="follow-mode-controls">
        <kbd>Space</kbd> {{ followModePaused() ? 'Resume' : 'Pause' }} ‚Ä¢ 
        <kbd>‚Üê</kbd><kbd>‚Üí</kbd> Navigate ‚Ä¢ 
        <kbd>Esc</kbd> Exit
      </small>
    </div>
  }

  <!-- Focus mode: floating settings access (pull tab on mobile, button on desktop) -->
  @if (focusMode()) {
    <div
      class="focus-pull-tab"
      (touchstart)="onPullTabTouchStart($event)"
      (touchmove)="onPullTabTouchMove($event)"
      (touchend)="onPullTabTouchEnd($event)"
      (click)="togglePanel()"
      role="button"
      aria-label="Swipe up or tap to open settings"
      title="Swipe up or tap to open settings">
      <div class="pull-tab-handle"></div>
      <span class="pull-tab-label">Settings</span>
    </div>
  }
</div>
