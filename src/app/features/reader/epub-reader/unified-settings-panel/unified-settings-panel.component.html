@if (isOpen) {
  <!-- Backdrop overlay -->
  <div 
    class="backdrop" 
    (click)="closePanel()" 
    (touchend)="closePanel()"
    (mousedown)="$event.stopPropagation()"
    (touchstart)="$event.stopPropagation()">
  </div>
  
  <aside
    class="unified-panel"
    role="dialog"
    aria-label="Reader settings panel"
    aria-modal="true"
    [attr.data-theme]="theme"
    [class.positioned]="panelX() !== null"
    (click)="$event.stopPropagation()"
    (touchstart)="$event.stopPropagation()">
    
    <!-- Panel header -->
    <header class="panel-header">
      <h3>{{ panelTitle }}</h3>
      <button class="close-btn" (click)="closePanel()" aria-label="Close panel">‚úï</button>
    </header>

    <!-- Exit focus mode banner (shown when focus mode is active) -->
    @if (settings.focusMode) {
      <div class="exit-focus-banner">
        <span class="exit-focus-text">üëÅÔ∏è Focus Mode is on</span>
        <button class="exit-focus-btn" (click)="exitFocusMode()" aria-label="Exit focus mode">
          Exit Focus Mode
        </button>
      </div>
    }

    <!-- Tab navigation -->
    <nav class="tab-nav" role="tablist">
      <button
        class="tab-button"
        [class.active]="activeTab() === 'settings'"
        (click)="switchTab('settings')"
        role="tab"
        [attr.aria-selected]="activeTab() === 'settings'"
        aria-label="Reader settings">
        ‚öôÔ∏è Settings
      </button>
      @if (!isPdf) {
      <button
        class="tab-button"
        [class.active]="activeTab() === 'chapters'"
        (click)="switchTab('chapters')"
        role="tab"
        [attr.aria-selected]="activeTab() === 'chapters'"
        aria-label="Table of contents">
        üìñ Chapters
      </button>
      }
      <!-- @if (!isPdf) {
      <button
        class="tab-button"
        [class.active]="activeTab() === 'pages'"
        (click)="switchTab('pages')"
        role="tab"
        [attr.aria-selected]="activeTab() === 'pages'"
        aria-label="Sections and pages">
        üìÑ Pages
      </button>
      } -->
      <button
        class="tab-button"
        [class.active]="activeTab() === 'bookmarks'"
        (click)="switchTab('bookmarks')"
        role="tab"
        [attr.aria-selected]="activeTab() === 'bookmarks'"
        aria-label="Bookmarks and progress">
        üîñ Bookmarks
      </button>
      @if (!isPdf) {
      <button
        class="tab-button"
        [class.active]="activeTab() === 'accessibility'"
        (click)="switchTab('accessibility')"
        role="tab"
        [attr.aria-selected]="activeTab() === 'accessibility'"
        aria-label="Accessibility options">
        ‚ôø Access
      </button>
      }
    </nav>

    <!-- Tab content -->
    <div class="tab-content">
      
      <!-- SETTINGS TAB -->
      @if (activeTab() === 'settings') {
        <div class="settings-tab" role="tabpanel">

          <!-- Dark Theme Toggle -->
          <div class="settings-section">
            <div class="toggle-switch-row">
              <span class="section-label">Dark theme</span>
              <button
                class="toggle-indicator"
                [class.active]="isDarkTheme"
                (click)="toggleDarkTheme()"
                role="switch"
                [attr.aria-checked]="isDarkTheme"
                aria-label="Toggle dark theme">
                @if (isDarkTheme) {
                  <svg class="toggle-icon-svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="white" stroke-width="3">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                } @else {
                  <svg class="toggle-icon-svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="white" stroke-width="3">
                    <line x1="6" y1="12" x2="18" y2="12"/>
                  </svg>
                }
              </button>
            </div>
          </div>

          <!-- Vertical Scroll Toggle - EPUB only -->
          @if (!isPdf) {
          <div class="settings-section">
            <div class="toggle-switch-row">
              <span class="section-label">Vertical scroll</span>
              <button
                class="toggle-indicator"
                [class.active]="settings.flowMode === 'scrolled'"
                (click)="updateFlowMode(settings.flowMode === 'scrolled' ? 'paginated' : 'scrolled')"
                role="switch"
                [attr.aria-checked]="settings.flowMode === 'scrolled'"
                aria-label="Toggle vertical scroll mode">
                @if (settings.flowMode === 'scrolled') {
                  <svg class="toggle-icon-svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="white" stroke-width="3">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                } @else {
                  <svg class="toggle-icon-svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="white" stroke-width="3">
                    <line x1="6" y1="12" x2="18" y2="12"/>
                  </svg>
                }
              </button>
            </div>
          </div>
          } <!-- end !isPdf for flow mode -->

          <!-- Zoom Level -->
          <!-- <div class="settings-section">
            <span class="section-label">Zoom</span>
            <div class="zoom-dropdown-wrapper">
              <button
                class="zoom-dropdown-trigger"
                (click)="toggleZoomDropdown()"
                [attr.aria-expanded]="zoomDropdownOpen()"
                aria-haspopup="listbox"
                aria-label="Select zoom level">
                <span>{{ currentZoomLabel }}</span>
                <span class="zoom-dropdown-arrow" [class.open]="zoomDropdownOpen()">‚ñæ</span>
              </button>
              @if (zoomDropdownOpen()) {
                <ul class="zoom-dropdown-menu" role="listbox" aria-label="Zoom level options">
                  @for (opt of zoomOptions; track opt.value) {
                    <li
                      class="zoom-dropdown-item"
                      [class.selected]="settings.zoomLevel === opt.value"
                      (click)="selectZoomLevel(opt.value)"
                      role="option"
                      [attr.aria-selected]="settings.zoomLevel === opt.value">
                      <span>{{ opt.label }}</span>
                      @if (settings.zoomLevel === opt.value) {
                        <span class="zoom-check">‚úì</span>
                      }
                    </li>
                  }
                </ul>
              }
            </div>
          </div> -->

          <!-- Page Layout (icon buttons) - EPUB only -->
          @if (!isPdf) {
          <div class="settings-section">
            <span class="section-label">Page layout</span>
            <div class="page-layout-buttons" role="radiogroup" aria-label="Page layout mode">
              @for (opt of pageLayoutOptions; track opt.value) {
                <button
                  class="page-layout-btn"
                  [class.selected]="settings.pageLayout === opt.value"
                  (click)="updatePageLayout(opt.value)"
                  [attr.aria-pressed]="settings.pageLayout === opt.value"
                  [attr.aria-label]="opt.label + ' layout'"
                  [title]="opt.label">
                  @if (opt.icon === 'auto') {
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor" aria-hidden="true">
                      <rect x="3" y="3" width="18" height="18" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
                      <text x="12" y="16" text-anchor="middle" font-size="11" font-weight="bold" fill="currentColor">A</text>
                    </svg>
                  }
                  @if (opt.icon === 'two-page') {
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor" aria-hidden="true">
                      <rect x="2" y="3" width="9" height="18" rx="1" fill="none" stroke="currentColor" stroke-width="2"/>
                      <rect x="13" y="3" width="9" height="18" rx="1" fill="none" stroke="currentColor" stroke-width="2"/>
                      <line x1="5" y1="7" x2="8" y2="7" stroke="currentColor" stroke-width="1.5"/>
                      <line x1="5" y1="10" x2="8" y2="10" stroke="currentColor" stroke-width="1.5"/>
                      <line x1="5" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="1.5"/>
                      <line x1="16" y1="7" x2="19" y2="7" stroke="currentColor" stroke-width="1.5"/>
                      <line x1="16" y1="10" x2="19" y2="10" stroke="currentColor" stroke-width="1.5"/>
                      <line x1="16" y1="13" x2="19" y2="13" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                  }
                  @if (opt.icon === 'one-page') {
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor" aria-hidden="true">
                      <rect x="5" y="3" width="14" height="18" rx="1" fill="none" stroke="currentColor" stroke-width="2"/>
                      <line x1="8" y1="7" x2="16" y2="7" stroke="currentColor" stroke-width="1.5"/>
                      <line x1="8" y1="10" x2="16" y2="10" stroke="currentColor" stroke-width="1.5"/>
                      <line x1="8" y1="13" x2="16" y2="13" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                  }
                </button>
              }
            </div>
          </div>
          } <!-- end !isPdf for page layout -->

          <!-- Divider before advanced settings -->
          <div class="settings-divider"></div>
          
          <!-- Font Family (EPUB only) -->
          @if (!isPdf) {
          <div class="settings-section">
            <span class="section-label">Font</span>
            <div class="font-buttons">
              @for (font of fonts; track font) {
                <button
                  class="font-btn"
                  [class.selected]="settings.fontFamily === font"
                  [style.font-family]="font"
                  (click)="updateFontFamily(font)"
                  [attr.aria-pressed]="settings.fontFamily === font"
                  [attr.aria-label]="font + ' font'">
                  {{ font }}
                </button>
              }
            </div>
          </div>

          <!-- Font Size (EPUB only) -->
          <div class="settings-section">
            <div class="control-header">
              <span class="section-label">Font Size</span>
              <div class="control-buttons">
                <button
                  class="control-btn"
                  (click)="decreaseFontSize()"
                  [disabled]="settings.fontSize <= FONT_SIZE_MIN"
                  aria-label="Decrease font size">
                  ‚àí
                </button>
                <span class="control-value">{{ settings.fontSize }}px</span>
                <button
                  class="control-btn"
                  (click)="increaseFontSize()"
                  aria-label="Increase font size">
                  +
                </button>
              </div>
            </div>
          </div>

          <!-- Line Height (EPUB only) -->
          <div class="settings-section">
            <div class="control-header">
              <span class="section-label">Line Height</span>
              <div class="control-buttons">
                <button
                  class="control-btn"
                  (click)="decreaseLineHeight()"
                  [disabled]="settings.lineHeight <= LINE_HEIGHT_MIN"
                  aria-label="Decrease line height">
                  ‚àí
                </button>
                <span class="control-value">{{ settings.lineHeight }}</span>
                <button
                  class="control-btn"
                  (click)="increaseLineHeight()"
                  aria-label="Increase line height">
                  +
                </button>
              </div>
            </div>
          </div>
          } <!-- end !isPdf for text controls -->

          <!-- Theme & Colors -->
          <!-- <div class="settings-section">
            <span class="section-label">Theme</span>
            <div class="theme-buttons" role="radiogroup" aria-label="Reader theme">
              @for (opt of themeOptions; track opt.value) {
                <button
                  class="theme-btn theme-btn--{{ opt.value }}"
                  [class.selected]="settings.theme === opt.value"
                  (click)="updateTheme(opt.value)"
                  [attr.aria-pressed]="settings.theme === opt.value"
                  [attr.aria-label]="opt.label + ' theme'">
                  {{ opt.label }}
                </button>
              }
            </div>
          </div> -->

          <!-- Color Palettes -->
          <div class="settings-section">
            <span class="section-label">Custom Color Palette</span>
            <div class="palette-grid">
              @for (palette of presetPalettes; track palette.name) {
                <button
                  class="palette-btn"
                  [class.selected]="isPaletteActive(palette)"
                  (click)="selectPresetPalette(palette)"
                  [attr.aria-pressed]="isPaletteActive(palette)"
                  [attr.aria-label]="palette.name + ' color palette'"
                  [title]="palette.name">
                  <span
                    class="palette-swatch"
                    [style.background]="palette.background"
                    [style.color]="palette.text"
                    [style.border-color]="palette.text + '33'">
                    Aa
                  </span>
                  <span class="palette-name">{{ palette.name }}</span>
                </button>
              }
            </div>
          </div>

          <!-- Custom Color Editor -->
          <div class="settings-section">
            <button
              class="custom-palette-toggle"
              (click)="toggleCustomPaletteEditor()"
              [attr.aria-expanded]="showCustomPaletteEditor()">
              <span>üé® Custom Colors</span>
              <span class="toggle-arrow" [class.open]="showCustomPaletteEditor()">‚ñæ</span>
            </button>
            @if (showCustomPaletteEditor()) {
              <div class="custom-palette-editor" role="group" aria-label="Custom color palette editor">
                <div class="color-row">
                  <label for="custom-bg">Background</label>
                  <div class="color-input-group">
                    <input
                      type="color"
                      id="custom-bg"
                      [value]="customBg()"
                      (input)="onCustomColorInput('bg', $event)"
                      aria-label="Custom background color" />
                    <span class="color-hex">{{ customBg() }}</span>
                  </div>
                </div>
                <div class="color-row">
                  <label for="custom-text">Text</label>
                  <div class="color-input-group">
                    <input
                      type="color"
                      id="custom-text"
                      [value]="customText()"
                      (input)="onCustomColorInput('text', $event)"
                      aria-label="Custom text color" />
                    <span class="color-hex">{{ customText() }}</span>
                  </div>
                </div>
                <div class="color-row">
                  <label for="custom-link">Links</label>
                  <div class="color-input-group">
                    <input
                      type="color"
                      id="custom-link"
                      [value]="customLink()"
                      (input)="onCustomColorInput('link', $event)"
                      aria-label="Custom link color" />
                    <span class="color-hex">{{ customLink() }}</span>
                  </div>
                </div>
                <div class="custom-palette-preview"
                  [style.background]="customBg()"
                  [style.color]="customText()"
                  aria-hidden="true">
                  Preview text with your colors
                </div>
                <div class="custom-palette-actions">
                  <button
                    class="apply-palette-btn"
                    (click)="applyCustomPalette()"
                    aria-label="Apply custom color palette">
                    Apply
                  </button>
                  @if (settings.customColorPalette) {
                    <button
                      class="clear-palette-btn"
                      (click)="clearCustomPalette()"
                      aria-label="Reset to default colors">
                      Reset
                    </button>
                  }
                </div>
              </div>
            }
          </div>

          <!-- Reading Modes Section -->
          <div class="settings-divider"></div>

          <!-- Toggle Modes
          <div class="settings-section">
            <span class="section-label">View Options</span>
            <div class="toggle-options">
              <button
                class="toggle-btn"
                [class.active]="settings.focusMode"
                (click)="toggleFocusMode()"
                [attr.aria-pressed]="settings.focusMode"
                title="Hide controls for distraction-free reading (press F to toggle)">
                <span class="toggle-icon">{{ settings.focusMode ? '‚úì' : '' }}</span>
                <span class="toggle-label">Focus Mode</span>
                <span class="toggle-hint">F</span>
              </button> -->
              <!-- <button
                class="toggle-btn"
                [class.active]="settings.followMode"
                (click)="toggleFollowMode()"
                [attr.aria-pressed]="settings.followMode"
                title="Highlight and follow text word by word (auto-advances)">
                <span class="toggle-icon">{{ settings.followMode ? '‚úì' : '' }}</span>
                <span class="toggle-label">Follow Mode</span>
                <span class="toggle-hint">‚Üí ‚Üê</span>
              </button> -->
            <!-- </div>
          </div>  -->

          <!-- Follow Mode Speed (only shown when follow mode is active) -->
          @if (settings.followMode) {
            <div class="settings-section follow-speed-section">
              <div class="control-header">
                <span class="section-label">Reading Speed</span>
                <div class="control-buttons">
                  <button
                    class="control-btn"
                    (click)="decreaseFollowSpeed()"
                    [disabled]="settings.followModeSpeed <= FOLLOW_MODE_SPEED_MIN"
                    aria-label="Decrease reading speed">
                    ‚àí
                  </button>
                  <span class="control-value">{{ settings.followModeSpeed }} WPM</span>
                  <button
                    class="control-btn"
                    (click)="increaseFollowSpeed()"
                    [disabled]="settings.followModeSpeed >= FOLLOW_MODE_SPEED_MAX"
                    aria-label="Increase reading speed">
                    +
                  </button>
                </div>
              </div>
              <p class="speed-hint">Words per minute (100-600)</p>
            </div>
          }

        </div>
      }

      <!-- CHAPTERS TAB -->
      @if (activeTab() === 'chapters') {
        <div class="chapters-tab" role="tabpanel">
          <nav class="chapters-list" role="navigation">
            @if (chapters.length === 0) {
              <p class="empty-message">No table of contents available</p>
            }
            @for (chapter of chapters; track chapter.id) {
              <div class="chapter-group">
                <button
                  class="chapter-item"
                  [class.current]="currentChapter === chapter.href"
                  (click)="onChapterClick(chapter)"
                  [attr.aria-current]="currentChapter === chapter.href ? 'true' : null">
                  <span class="chapter-label">{{ chapter.label }}</span>
                </button>
                @if (chapter.subitems && chapter.subitems.length > 0) {
                  <div class="chapter-subitems">
                    @for (subchapter of chapter.subitems; track subchapter.id) {
                      <button
                        class="chapter-item chapter-item--sub"
                        [class.current]="currentChapter === subchapter.href"
                        (click)="onChapterClick(subchapter)"
                        [attr.aria-current]="currentChapter === subchapter.href ? 'true' : null">
                        <span class="chapter-label">{{ subchapter.label }}</span>
                      </button>
                    }
                  </div>
                }
              </div>
            }
          </nav>
        </div>
      }

      <!-- PAGES TAB -->
      <!-- @if (activeTab() === 'pages') {
        <div class="pages-tab" role="tabpanel">
          @if (spineItems.length === 0) {
            <p class="empty-message">No sections available</p>
          }
          <div class="spine-grid">
            @for (item of spineItems; track item.index) {
              <button
                class="spine-card"
                [class.current]="currentSpineIndex === item.index"
                (click)="onSpineClick(item)"
                [attr.aria-label]="'Go to ' + item.label"
                [attr.aria-current]="currentSpineIndex === item.index ? 'true' : null">
                <div class="spine-card-preview">
                  @if (item.previewText) {
                    <div class="spine-preview-text">{{ item.previewText }}</div>
                  } @else {
                    <div class="spine-preview-placeholder">
                      <span class="spine-preview-icon">üìÑ</span>
                    </div>
                  }
                </div>
                <span class="spine-card-label">{{ item.index + 1 }}</span>
              </button>
            }
          </div>
        </div>
      } -->

      <!-- BOOKMARKS TAB -->
      @if (activeTab() === 'bookmarks') {
        <div class="bookmarks-tab" role="tabpanel">
          
          <!-- Bookmarks list -->
          <div class="bookmarks-section">
            <h4 class="section-title">üîñ Your Bookmarks</h4>
            <div class="bookmarks-list">
              @if (bookmarks.length === 0) {
                <p class="empty-message">No bookmarks yet. Tap üè∑Ô∏è to add one.</p>
              }
              @for (bm of bookmarks; track bm.id) {
                <div class="bookmark-item" (click)="onBookmarkClick(bm)" role="button" tabindex="0">
                  <span class="bookmark-label">{{ bm.label }}</span>
                  <span class="bookmark-date">{{ bm.createdAt | date: 'short' }}</span>
                  <button
                    class="bookmark-remove"
                    (click)="onBookmarkRemove(bm.id, $event)"
                    aria-label="Remove bookmark"
                    title="Remove">
                    ‚úï
                  </button>
                </div>
              }
            </div>
          </div>

          <!-- Reading progress -->
          @if (progressPercent !== null && progressPercent >= 0) {
            <div class="reading-progress-section">
              <h4 class="section-title">üìà Book Progress</h4>
              <div class="progress-overview">
                <div class="progress-bar-track">
                  <div class="progress-bar-fill" [style.width.%]="progressPercent"></div>
                </div>
                <span class="progress-text">{{ progressPercent }}% complete</span>
              </div>
            </div>
          }

          <!-- Reading stats -->
          @if (readingStats && readingStats.totalReadingTime > 0) {
            <div class="reading-stats-section">
              <h4 class="section-title">üìä Reading Stats</h4>
              <div class="stats-grid">
                <div class="stat-item">
                  <span class="stat-value">{{ formatDuration(readingStats.totalReadingTime) }}</span>
                  <span class="stat-label">Total time</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ readingStats.sessions.length }}</span>
                  <span class="stat-label">Sessions</span>
                </div>
                @if (todayReadingTime !== null) {
                  <div class="stat-item">
                    <span class="stat-value">{{ formatDuration(todayReadingTime) }}</span>
                    <span class="stat-label">Today</span>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Reading goal -->
          @if (readingGoal) {
            <div class="reading-goal-section">
              <h4 class="section-title">üéØ Reading Goal</h4>
              <div class="goal-streak">
                <span class="streak-flame">üî•</span>
                <span class="streak-count">{{ readingGoal.currentStreak }} day streak</span>
              </div>
            </div>
          }

        </div>
      }

      <!-- ACCESSIBILITY TAB -->
      @if (activeTab() === 'accessibility') {
        <div class="accessibility-tab" role="tabpanel" aria-label="Accessibility settings">
          
          <!-- Letter Spacing -->
          <div class="settings-section">
            <div class="control-header">
              <span class="section-label">Letter Spacing</span>
              <div class="control-buttons">
                <button
                  class="control-btn"
                  (click)="decreaseLetterSpacing()"
                  [disabled]="settings.letterSpacing <= LETTER_SPACING_MIN"
                  aria-label="Decrease letter spacing">
                  ‚àí
                </button>
                <span class="control-value">{{ settings.letterSpacing.toFixed(2) }}em</span>
                <button
                  class="control-btn"
                  (click)="increaseLetterSpacing()"
                  [disabled]="settings.letterSpacing >= LETTER_SPACING_MAX"
                  aria-label="Increase letter spacing">
                  +
                </button>
              </div>
            </div>
          </div>

          <!-- Reading Aids -->
          <div class="settings-section">
            <span class="section-label">Reading Aids</span>
            <div class="toggle-options">
              <button
                class="toggle-btn"
                [class.active]="settings.wordHighlighting"
                (click)="toggleWordHighlighting()"
                [attr.aria-pressed]="settings.wordHighlighting"
                title="Highlight the current sentence while reading for easier tracking">
                <span class="toggle-icon">{{ settings.wordHighlighting ? '‚úì' : '' }}</span>
                <span class="toggle-label">Sentence Highlighting</span>
              </button>
              <button
                class="toggle-btn"
                [class.active]="settings.bionicReading"
                (click)="toggleBionicReading()"
                [attr.aria-pressed]="settings.bionicReading"
                title="Bold the first portion of each word for faster reading">
                <span class="toggle-icon">{{ settings.bionicReading ? '‚úì' : '' }}</span>
                <span class="toggle-label">Bionic Reading</span>
              </button>
            </div>
            @if (settings.bionicReading) {
              <div class="bionic-preview" aria-hidden="true">
                <p class="bionic-preview-text">
                  <strong>Thi</strong>s is <strong>ho</strong>w <strong>bion</strong>ic <strong>rea</strong>ding <strong>loo</strong>ks. <strong>Yo</strong>ur <strong>bra</strong>in <strong>comple</strong>tes <strong>th</strong>e <strong>wor</strong>ds.
                </p>
              </div>
            }
          </div>

          <!-- Screen Reader Info -->
          <div class="settings-divider"></div>
          <div class="settings-section">
            <span class="section-label">Screen Reader</span>
            <div class="sr-info-card" role="note">
              <p>This reader supports screen reader navigation. Use your screen reader's heading and landmark navigation to move through book content.</p>
              <ul class="sr-shortcuts">
                <li><kbd>‚Üê</kbd> <kbd>‚Üí</kbd> Navigate pages</li>
                <li><kbd>F</kbd> Toggle focus mode</li>
                <li><kbd>B</kbd> Toggle bookmark</li>
                <li><kbd>O</kbd> Open settings</li>
              </ul>
            </div>
          </div>

        </div>
      }

    </div>
  </aside>
}
