<div class="library-shell">
  <!-- Top Bar â€” full width above everything -->
  <header class="top-bar">
    <div class="brand">
      <span class="brand-icon">ğŸ“–</span>
      <span class="brand-name">LightReader</span>
    </div>
    <div class="search-bar">
      <span class="search-icon">ğŸ”</span>
      <input
        type="text"
        placeholder="Search"
        class="search-input"
        [(ngModel)]="searchQuery"
        (ngModelChange)="onSearchChange()"
      />
    </div>
    <div class="top-bar-actions"></div>
  </header>

  <!-- Body: Sidebar + Content -->
  <div class="library-body">
    <!-- Sidebar -->
    <aside class="sidebar">
      <nav class="sidebar-nav">
      <button class="nav-item active">
        <span class="nav-icon">ğŸ“š</span>
        <span class="nav-label">Books</span>
        @if (documents$ | async; as docs) {
          <span class="nav-count">{{ docs.length }}</span>
        }
      </button>
      <button class="nav-item" disabled>
        <span class="nav-icon">ğŸ“–</span>
        <span class="nav-label">Series</span>
        <span class="nav-count">0</span>
      </button>
      <button class="nav-item" disabled>
        <span class="nav-icon">ğŸ™ˆ</span>
        <span class="nav-label">Hidden</span>
      </button>
    </nav>

    <div class="sidebar-section">
      <div class="sidebar-section-header" (click)="shelvesExpanded = !shelvesExpanded">
        <span>Shelves</span>
        <span class="chevron" [class.expanded]="shelvesExpanded">â–¸</span>
      </div>
      @if (shelvesExpanded) {
        <div class="shelf-list">
          @if (documents$ | async; as docs) {
            <div class="shelf-item">
              @if (docs.length > 0 && getCoverImage(docs[0])) {
                <img class="shelf-thumb" [src]="getCoverImage(docs[0])" alt="" />
              } @else {
                <span class="shelf-thumb-placeholder">ğŸ“š</span>
              }
              <span class="shelf-name">Unshelved</span>
              <span class="nav-count">{{ docs.length }}</span>
            </div>
          }
          <button class="btn-create-shelf" disabled>
            <span class="create-icon">âœï¸</span>
            <span>Create shelf</span>
          </button>
        </div>
      }
    </div>
  </aside>

    <!-- Main Content -->
    <main class="main-content">
      @if (loading$ | async) {
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading your library...</p>
      </div>
    }

    @if (filteredDocuments$ | async; as documents) {
      @if (documents.length > 0) {
        <!-- Content Header -->
        <div class="content-header">
          <h1 class="content-title">Books</h1>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
          <div class="toolbar-left">
            <button class="toolbar-btn" [class.active]="sortBy === 'recent'" (click)="sortBy = 'recent'">
              <span class="toolbar-icon">â‰¡</span>
              Recent
              <span class="dropdown-arrow">â–¾</span>
            </button>
            <button class="toolbar-btn" [class.active]="sortBy === 'progress'" (click)="sortBy = 'progress'">
              Progress
              <span class="dropdown-arrow">â–¾</span>
            </button>
          </div>
          <div class="toolbar-right">
            <div class="view-toggle">
              <button class="view-btn" [class.active]="viewMode === 'grid'" (click)="viewMode = 'grid'" title="Grid view">âŠ</button>
              <button class="view-btn" [class.active]="viewMode === 'list'" (click)="viewMode = 'list'" title="List view">â˜°</button>
            </div>
            <app-upload></app-upload>
          </div>
        </div>

        <!-- Books Grid -->
        @if (viewMode === 'grid') {
          <div class="books-grid">
            @for (doc of documents; track doc.id) {
              <div class="book-card" [class.menu-open]="openMenuId === doc.id" (click)="openDocument(doc.id)">
                <div class="book-cover-wrapper">
                  @if (getCoverImage(doc)) {
                    <img class="book-cover-img" [src]="getCoverImage(doc)" [alt]="doc.title" />
                  } @else {
                    <div class="book-cover-fallback">
                      <span class="fallback-icon">{{ doc.type === 'epub' ? 'ğŸ“–' : 'ğŸ“„' }}</span>
                      <span class="fallback-title">{{ doc.title }}</span>
                    </div>
                  }
                  @if (doc.readingProgressPercent || (doc.currentPage && doc.totalPages)) {
                    <div class="cover-progress">
                      <div class="cover-progress-fill" [style.width.%]="getProgress(doc)"></div>
                    </div>
                  }
                </div>
                <div class="book-meta">
                  <span class="book-title">{{ doc.title }}</span>
                  <span class="book-author">{{ getAuthor(doc) }}</span>
                </div>
                <button class="btn-more" (click)="toggleMenu(doc.id, $event)" title="More options">â‹®</button>

                <!-- Context Menu -->
                @if (openMenuId === doc.id) {
                  <div class="context-menu">
                    <button class="menu-item" (click)="openEditModal(doc, $event)">
                      <span>âœï¸</span> Edit details
                    </button>
                    <button class="menu-item" (click)="fetchMetadata(doc, $event)">
                      <span>ğŸ”„</span> Fetch metadata
                    </button>
                    <div class="menu-divider"></div>
                    <button class="menu-item menu-item-danger" (click)="deleteDocument(doc.id); $event.stopPropagation()">
                      <span>ğŸ—‘ï¸</span> Delete
                    </button>
                  </div>
                }
              </div>
            }
          </div>
        }

        <!-- Books List -->
        @if (viewMode === 'list') {
          <div class="books-list-view">
            @for (doc of documents; track doc.id) {
              <div class="list-row" (click)="openDocument(doc.id)">
                <div class="list-cover">
                  @if (getCoverImage(doc)) {
                    <img [src]="getCoverImage(doc)" [alt]="doc.title" />
                  } @else {
                    <div class="list-cover-fallback">{{ doc.type === 'epub' ? 'ğŸ“–' : 'ğŸ“„' }}</div>
                  }
                </div>
                <div class="list-info">
                  <span class="list-title">{{ doc.title }}</span>
                  <span class="list-author">{{ getAuthor(doc) }}</span>
                </div>
                @if (doc.readingProgressPercent || (doc.currentPage && doc.totalPages)) {
                  <div class="list-progress">
                    <div class="list-progress-bar">
                      <div class="list-progress-fill" [style.width.%]="getProgress(doc)"></div>
                    </div>
                    <span class="list-progress-text">{{ getProgress(doc) }}%</span>
                  </div>
                }
                <button class="btn-more" (click)="toggleMenu(doc.id, $event)" title="More options">â‹®</button>

                @if (openMenuId === doc.id) {
                  <div class="context-menu">
                    <button class="menu-item" (click)="openEditModal(doc, $event)">
                      <span>âœï¸</span> Edit details
                    </button>
                    <button class="menu-item" (click)="fetchMetadata(doc, $event)">
                      <span>ğŸ”„</span> Fetch metadata
                    </button>
                    <div class="menu-divider"></div>
                    <button class="menu-item menu-item-danger" (click)="deleteDocument(doc.id); $event.stopPropagation()">
                      <span>ğŸ—‘ï¸</span> Delete
                    </button>
                  </div>
                }
              </div>
            }
          </div>
        }

      } @else {
        <div class="empty-state">
          <div class="empty-icon">ğŸ“š</div>
          <h3>No books yet</h3>
          <p>Upload an EPUB or PDF to get started</p>
          <app-upload></app-upload>
        </div>
      }
    }
    </main>
  </div>
</div>

<!-- Backdrop to close menus -->
@if (openMenuId) {
  <div class="menu-backdrop" (click)="openMenuId = null"></div>
}

<!-- Edit Modal -->
@if (editingDocument) {
  <app-edit-book-modal
    [document]="editingDocument"
    (close)="closeEditModal()"
    (save)="saveMetadata($event)"
  ></app-edit-book-modal>
}
