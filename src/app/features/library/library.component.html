<div class="library-shell">
  <!-- Top Bar ‚Äî full width above everything -->
  <app-library-top-bar
    [searchQuery]="searchQuery"
    (searchChange)="searchQuery = $event; onSearchChange()"
  ></app-library-top-bar>

  <!-- Body: Sidebar + Content -->
  <div class="library-body" cdkDropListGroup>
    <app-library-sidebar
      [documents$]="documents$"
      [shelves$]="shelves$"
      [selectedShelfId$]="selectedShelfId$"
      [shelvesExpanded]="shelvesExpanded"
      [mobileOpen]="(sidebarOpen$ | async) ?? false"
      (toggleShelves)="shelvesExpanded = $event"
      (selectShelf)="selectShelf($event)"
      (createShelf)="openCreateShelfModal()"
      (deleteShelf)="deleteShelf($event.id, $event.event)"
      (bookDropped)="onBookDrop($event.dropEvent, $event.targetShelfId)"
    ></app-library-sidebar>

    <!-- Main Content -->
    <main
      class="main-content"
      [class.file-drag-over]="fileDragOver"
      (dragover)="onFileDragOver($event)"
      (dragenter)="onFileDragEnter($event)"
      (dragleave)="onFileDragLeave($event)"
      (drop)="onFileDrop($event)"
    >
      <!-- Drop zone overlay -->
      @if (fileDragOver) {
        <div class="drop-zone-overlay">
          <div class="drop-zone-content">
            <span class="drop-zone-icon">üìÇ</span>
            <p class="drop-zone-text">Drop EPUB or PDF files here</p>
          </div>
        </div>
      }

      @if (loading$ | async) {
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading your library...</p>
      </div>
    }

    @if (filteredDocuments$ | async; as documents) {
      @if (documents.length > 0) {
        <!-- Content Header -->
        <div class="content-header">
          <h1 class="content-title">Books</h1>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
          <div class="toolbar-left">
            <div class="toolbar-dropdown">
              <button class="toolbar-btn" [class.active]="sortBy === 'recent'" (click)="toggleSortMenu('recent', $event)">
                <span class="toolbar-icon">‚â°</span>
                Recent
                <span class="dropdown-arrow">‚ñæ</span>
              </button>
              <div class="dropdown-menu" *ngIf="openSortMenu === 'recent'">
                <button class="menu-item" (click)="setSort('recent', 'desc'); $event.stopPropagation()">Newest first</button>
                <button class="menu-item" (click)="setSort('recent', 'asc'); $event.stopPropagation()">Oldest first</button>
              </div>
            </div>

            <div class="toolbar-dropdown">
              <button class="toolbar-btn" [class.active]="sortBy === 'progress'" (click)="toggleSortMenu('progress', $event)">
                Progress
                <span class="dropdown-arrow">‚ñæ</span>
              </button>
              <div class="dropdown-menu" *ngIf="openSortMenu === 'progress'">
                <button class="menu-item" (click)="setSort('progress', 'desc'); $event.stopPropagation()">Highest progress</button>
                <button class="menu-item" (click)="setSort('progress', 'asc'); $event.stopPropagation()">Lowest progress</button>
              </div>
            </div>
          </div>
          <div class="toolbar-right">
            <div class="view-toggle">
              <button class="view-btn" [class.active]="viewMode === 'grid'" (click)="viewMode = 'grid'" title="Grid view">‚äû</button>
              <button class="view-btn" [class.active]="viewMode === 'list'" (click)="viewMode = 'list'" title="List view">‚ò∞</button>
            </div>
            <!-- <div class="backup-badge-wrapper">
              <button class="toolbar-btn" title="Import / Export" (click)="openImportExportModal()">‚áÑ</button>
              @if (lastBackupTime) {
                <span class="backup-badge">Updated {{ lastBackupTime }}</span>
              }
            </div> -->
            <app-upload></app-upload>
          </div>
        </div>

        <!-- Books Grid -->
        @if (viewMode === 'grid') {
          <div class="books-grid" cdkDropList id="books-grid" [cdkDropListData]="documents" (cdkDropListDropped)="onMainListDropped($event)">
            @for (doc of documents; track doc.id) {
              <app-book-card
                [doc]="doc"
                [openMenuId]="openMenuId"
                (open)="openDocument($event)"
                (toggleMenu)="toggleMenu($event.id, $event.event)"
                (edit)="openEditModal($event.doc, $event.event)"
                (fetchMetadata)="fetchMetadata($event.doc, $event.event)"
                (delete)="deleteDocument($event)"
                (download)="downloadDocument($event.doc, $event.event)"
                (dragStarted)="onDragStarted($event)"
                (dragEnded)="onDragEnded($event)"
              ></app-book-card>
            }
          </div>
        }

        <!-- Books List -->
        @if (viewMode === 'list') {
          <div class="books-list-view" cdkDropList id="books-list" [cdkDropListData]="documents" (cdkDropListDropped)="onMainListDropped($event)">
            @for (doc of documents; track doc.id) {
              <div
                class="list-row"
                (click)="openDocument(doc.id)"
                cdkDrag
                [cdkDragData]="doc.id"
                (cdkDragStarted)="onDragStarted(doc.id)"
                (cdkDragEnded)="onDragEnded(doc.id)"
              >
                <button class="drag-handle list-drag-handle" cdkDragHandle (click)="$event.stopPropagation()" title="Drag to shelf">‚†ø</button>
                <div class="list-cover">
                    <div class="list-cover-fallback">{{ doc.type === 'epub' ? 'üìñ' : 'üìÑ' }}</div>
                </div>
                <div class="list-info">
                  <span class="list-title">{{ doc.title }}</span>
                  <span class="list-author">{{ getAuthor(doc) }}</span>
                </div>
                @if (doc.readingProgressPercent || (doc.currentPage && doc.totalPages)) {
                  <div class="list-progress">
                    <div class="list-progress-bar">
                      <div class="list-progress-fill" [style.width.%]="getProgress(doc)"></div>
                    </div>
                    <span class="list-progress-text">{{ getProgress(doc) }}%</span>
                  </div>
                }
                <button class="btn-more" (click)="toggleMenu(doc.id, $event)" title="More options">‚ãÆ</button>

                @if (openMenuId === doc.id) {
                  <div class="context-menu">
                    <button class="menu-item" (click)="openEditModal(doc, $event)">
                      <span>‚úèÔ∏è</span> Edit details
                    </button>
                    <!-- <button class="menu-item" (click)="fetchMetadata(doc, $event)">
                      <span>üîÑ</span> Fetch metadata
                    </button> -->
                    <div class="menu-divider"></div>
                    <button class="menu-item menu-item-danger" (click)="deleteDocument(doc.id); $event.stopPropagation()">
                      <span>üóëÔ∏è</span> Delete
                    </button>
                  </div>
                }
              </div>
            }
          </div>
        }

      } @else {
        <div class="empty-state">
          <div class="empty-icon">üìö</div>
          <h3>No books yet</h3>
          <p>Upload an EPUB or PDF to get started</p>
          <div class="flex layout-row layout-align-center-center empty-actions" style="gap: 10px;">
            <app-upload></app-upload>
            <!-- <button class="toolbar-btn" title="Import / Export" (click)="openImportExportModal()">‚áÑ Import / Export</button> -->
          </div>
        </div>
      }
    }
    </main>
  </div>
</div>

<!-- Mobile sidebar backdrop -->
@if (sidebarOpen$ | async; as _open) {
  <div class="mobile-backdrop" (click)="closeMobileSidebar()"></div>
}

<!-- Backdrop to close menus -->
@if (openMenuId) {
  <div class="menu-backdrop" (click)="openMenuId = null"></div>
}

<!-- Edit Modal -->
@if (editingDocument) {
  <app-edit-book-modal
    [document]="editingDocument"
    (close)="closeEditModal()"
    (save)="saveMetadata($event)"
  ></app-edit-book-modal>
}
